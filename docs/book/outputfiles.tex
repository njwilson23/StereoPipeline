\chapter{Guide to Output Files}
\label{chapter:outputfiles}

The {\tt stereo} tool generates a variety of intermediate files that
are useful for debugging.  These are listed below, along with brief
descriptions about the contents of each file.  Note that the prefix of
the filename for all of these files is dictated by the final command
line argument to {\tt stereo}.  Run {\tt stereo -\/-help} for details.

\begin{description}

\item[*.vwip \textnormal{- image feature files}] \hfill \\
  If \texttt{alignment-method} is not \texttt{none}, the Stereo
  Pipeline will automatically search for image features to use for
  tie-points.  Raw image features are stored in \texttt{*.vwip} files;
  one per input image. For example, if your images are
  \texttt{left.cub} and \texttt{right.cub} you'll get
  \texttt{left.vwip} and \texttt{right.vwip}.  Note: these files can
  also be generated by hand (and with finer grained control over
  detection algorithm options) using the {\tt ipfind} utility.

\item[*.match \textnormal{- image to image tie-points}] \hfill \\
  The match file lists a select group of unique points out of the
  previous \texttt{.vwip} files that have been identified and matched
  in a pair of images.  For example, if your images are
  \texttt{left.cub} and \texttt{right.cub} you'll get a
  \texttt{left\_\_right.match} file.

  The \texttt{.vwip} and \texttt{.match} files are meant to serve
  as cached tie-point information, and they help speed up the
  pre-processing phase of the Stereo Pipeline: if these files exist
  then the \texttt{stereo} program will skip over the interest point
  alignment stage and instead use the cached tie-points contained
  in the \texttt{*.match} files.  In the rare case that one of these files
  did get corrupted or your input images have changed, you may want
  to delete these files and allow {\tt stereo} to regenerate them
  automatically.  This is also recommended if you have upgraded the
  Stereo Pipeline software.

\item[*-L.tif - \textnormal{rectified left input image}] \hfill \\
  The left input image of the stereo pair, saved after the
  pre-processing step.  This image may be normalized, but should
  otherwise be identical to the original left input image.

\item[*-R.tif - \textnormal{rectified right input image}] \hfill \\
  Right input image of the stereo pair, after the pre-processing
  step.  This image may be normalized and possibly
    translated, scaled, and/or rotated to roughly align it with the left
    image, but should otherwise be identical to the original right
  input image.

\item[*-lMask.tif \textnormal{- mask for left rectified image}]
\item[*-rMask.tif \textnormal{- mask for right rectified image}] \hfill \\
  These files contain binary masks for the input images.  These are
  used throughout the stereo process to mask out pixels where there is
  no input data.

\item[*-align-L.exr \textnormal{- left pre-alignment matrix}]
\item[*-align-R.exr \textnormal{- right pre-alignment matrix}] \hfill \\
 The $3 \times 3$ affine transformation matrices that are used to warp
 the left and right images to roughly align them. These files are only
 generated if \texttt{alignment-method} is not \texttt{none} in the {\tt
 stereo.default} file. Normally, a single transform is enough to warp one
 image to another (for example, the right image to the left). The reason
 we use two transforms is the following: after the right image is warped
 to the left, we would like to additionally transform both images so that
 the origin (0, 0) in the left image would correspond to the same
 location in the right image. This will somewhat improve the efficiency
 of subsequent processing.

\item[*-D.tif \textnormal{- disparity map after the disparity map initialization phase}] \hfill \\
  This is the disparity map generated by the correlation algorithm in
  the initialization phase.  It contains integer values of disparity
  that are used to seed the subsequent sub-pixel correlation phase.
  It is largely unfiltered, and may contain some bad matches.

  Disparity map files are stored in OpenEXR format as 3-channel,
  32-bit floating point images.  (Channel 0 = horizontal disparity,
  Channel 1 = vertical disparity, and Channel 2 = good pixel mask)

\item[*-RD.tif - \textnormal{disparity map after sub-pixel correlation}] \hfill \\
  This file contains the disparity map after sub-pixel refinement.
  Pixel values now have sub-pixel precision, and some outliers have
  been rejected by the sub-pixel matching process.

\item[*-F-corrected.tif \textnormal{- intermediate data product}] \hfill \\
  Only created when \texttt{alignment-method} is not \texttt{none}.
  This is \texttt{*-F.tif} with effects of interest point alignment removed.

\item[*-F.tif \textnormal{- filtered disparity map}] \hfill \\
  The filtered, sub-pixel disparity map with outliers removed (and
  holes filled with the inpainting algorithm if \texttt{FILL\_HOLES}
  is on). This is the final version of the disparity map.

\item[*-GoodPixelMap.tif \textnormal{- map of good pixels}] \hfill \\
  An image showing which pixels were matched by the stereo correlator
  (gray pixels), and which were filled in by the hole filling
  algorithm (red pixels).

\item[*-PC.tif \textnormal{- point cloud image}] \hfill \\ The point
cloud image is generated by the triangulation phase of Stereo Pipeline.
Each pixel in the point cloud image corresponds to a pixel in the left
input image (*-L.tif). The point cloud has four channels, the first
three are the Cartesian coordinates of each point, and the last one has
the intersection error of the two rays which created that point (the
intersection error is the closest distance between rays).  By default,
the origin of the Cartesian coordinate system being used is a point in
the neighborhood of the point cloud. This makes the values of the points
in the cloud relatively small, and we save them in single precision (32
bits). This origin is saved in the point cloud as well using the tag
POINT\_OFFSET in the GeoTiff header. To output point clouds using double
precision with the origin at the planet center, call {\tt stereo\_tri}
with the option {\tt -\/-save-double-precision-point-cloud}. This can
effectively double the size of the point cloud.

All these images that are single-band can be visualized in
\texttt{stereo\_gui} (section \ref{stereo_gui}). The disparities
can be first split into the individual horizontal and vertical
disparity files using \texttt{disparitydebug}, then they can be
seen in this viewer as well.

If the input images are map-projected (georeferenced) and the alignment
method is \texttt{none}, all the output images listed above, will also
be georeferenced, and hence can be overlayed in \texttt{stereo\_gui} on
top of the input imagery (the outputs of \texttt{disparitydebug} will
then be georeferenced as well).

The point cloud file saves the datum (and projection if available)
inferred from the input images, regardless of whether these images
are map-projected or not.

The {\tt point2mesh} and {\tt point2dem} programs can be used
to convert the point cloud to formats that are easier to visualize.

\item[*-stereo.default \textnormal{- backup of the Stereo Pipeline settings file}] \hfill \\
  This is a copy of the \texttt{stereo.default} file used by
  \texttt{stereo}.  It is stored alongside the output products as
  a record of the settings that were used for this particular stereo
  processing task.

\end{description}
